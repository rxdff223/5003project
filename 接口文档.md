# 接口文档

## 概览
- 基础地址：默认本地 `http://localhost:8000/`（内网穿透后替换为你的公网域名）
- 鉴权方式：`Authorization: Bearer <token>`（登录后获得令牌）
- 响应结构：`{ code: string, message: string, data: any }`
- 错误码：`OK`、`BAD_REQUEST`、`UNAUTHORIZED`、`FORBIDDEN`、`NOT_FOUND`、`CONFLICT`、`RATE_LIMITED`、`INTERNAL_ERROR`
- 分页：`page`（默认1）、`page_size`（默认20，上限100）；响应含 `total`

## 认证与用户
- POST `/auth/register`
  - Body：`{ phone, password, nickname? }`
  - 200：`{ user: { id, phone, nickname, tag, default_city_id, role }, token }`
  - 409：`phone exists`
  - 400：`phone and password required`
  - 代码位置：`backend/app/api/auth/routes.py:8`
- POST `/auth/login`
  - Body：`{ phone, password }`
  - 200：`{ token, user: { id, phone, nickname, tag, default_city_id, role } }`
  - 401：`invalid credentials`
  - 400：`phone and password required`
  - 代码位置：`backend/app/api/auth/routes.py:22`
- GET `/auth/me`
  - Header：`Authorization: Bearer <token>`
  - 200：`{ id, phone, nickname, tag, default_city_id, role }`
  - 401：`missing token | invalid token | user not found`
  - 代码位置：`backend/app/api/auth/routes.py:35`

## 用户中心
- GET `/users/me`
  - Header：`Authorization: Bearer <token>`
  - 200：`{ id, phone, nickname, tag, default_city_id, role }`
  - 401：`missing token | invalid token | user not found`
  - 示例：
```
curl http://localhost:8000/users/me \
  -H "Authorization: Bearer <token>"
```
- PUT `/users/me`
  - Header：`Authorization: Bearer <token>`
  - Body：`{ nickname?, phone?, default_city_id? }`
  - 200：更新后的用户：`{ id, phone, nickname, tag, default_city_id, role }`
  - 400：`BAD_REQUEST`（参数格式错误或无可更新字段）
  - 409：`CONFLICT`（`phone` 已存在）
  - 401：`UNAUTHORIZED`（令牌缺失/无效）
  - 示例：
```
curl -X PUT http://localhost:8000/users/me \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d "{\"nickname\":\"新昵称\",\"default_city_id\":123}"
```
- PUT `/users/me/tags`
  - Header：`Authorization: Bearer <token>`
  - Body：`{ tag }`（枚举：`normal|elderly|children|asthma|pregnant`）
  - 200：更新后的用户：`{ id, phone, nickname, tag, default_city_id, role }`
  - 400：`BAD_REQUEST`（`tag` 非允许值或缺失）
  - 401：`UNAUTHORIZED`（令牌缺失/无效）
  - 示例：
```
curl -X PUT http://localhost:8000/users/me/tags \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d "{\"tag\":\"asthma\"}"
```

## 城市与数据查询（规划）
- GET `/cities`
  - Query：`q?`、`province?`、`page?`、`page_size?`
  - 200：`{ items: [ { id, name, province, lat, lon } ], total }`
- GET `/data/query`
  - Query：`city_id`、`start_time`、`end_time`、`pollutant`、`page?`、`page_size?`
  - 200：历史数据列表
- GET `/data/detail`
  - Query：`city_id`、`time?`
  - 200：`{ weather, aqi:{ value, level, dominentpol }, pollutants:{ pm25, pm10, ... }, time, attributions }`

## 月度统计（规划）
- GET `/data/monthly-stats`
  - Query：`city_id`、`months?=12`
  - 200：`{ items: [ { month:"YYYY-MM", good_ratio, pm25_avg } ] }`

## 预测（规划）
- GET `/forecast/24h`
  - Query：`city_id`
  - 200：`{ hours | day-level: { pm25:{avg,max,min}, source:"aqicn", cache_ttl } }`
  - 404：城市无预测数据

## 健康建议（规划）
- GET `/advice/realtime`
  - Query：`city_id`、`tag?`
  - 200：建议集合
- GET `/advice/warning-24h`
  - Query：`city_id`、`tag?`
  - 200：未来 24 小时预警提示

## 热搜与分析（规划）
- GET `/analytics/usage`
  - Query：`start_time`、`end_time`
  - 200：`{ dau, features:[{ name, count }] }`
- GET `/hot/top-cities`
  - Query：`limit?=5`、`start_time?`、`end_time?`
  - 200：热门城市榜

## 管理员（规划）：城市管理
- POST `/admin/cities`
  - Body：`{ name, province, lat, lon }`
  - 200：新城市；409：同名冲突
- PUT `/admin/cities/{id}`
  - Body：`{ name?, province?, lat?, lon? }`
  - 200：更新后的城市
- DELETE `/admin/cities/{id}`
  - 204：删除成功；404：未找到

## 管理员（规划）：数据同步
- POST `/admin/sync/run`
  - Body：`{ source:"openaq"|"aqicn", city_ids?: number[] }`
  - 200：`{ job_id, accepted_at }`
- GET `/admin/sync/logs`
  - Query：`page?`、`page_size?`、`source?`
  - 200：同步日志列表
- POST `/admin/sync/retry/{failure_id}`
  - 200：`{ status:"queued", failure_id }`

## 管理员（规划）：建议库
- GET `/admin/advice-rules`
  - Query：`pollutant?`、`level?`、`tag?`、`page?`、`page_size?`
  - 200：规则列表
- POST `/admin/advice-rules`
  - Body：`{ pollutant, level, tag, text, effective_from?, effective_to? }`
  - 200：新增规则
- PUT `/admin/advice-rules/{id}`
  - Body：部分字段更新
  - 200：更新规则
- DELETE `/admin/advice-rules/{id}`
  - 204：删除成功

## 管理员（规划）：系统监控
- GET `/admin/monitor/sync`
  - Query：`days?=7`
  - 200：近 7 天成功率与平均耗时
- GET `/admin/monitor/usage`
  - Query：`start_time`、`end_time`
  - 200：`{ dau, features, top_cities }`

## AQICN 对接要点
- 基础域名：`https://api.waqi.info`
- 令牌：通过环境变量 `AQICN_TOKEN` 提供（不入库/不写入代码）
- 常用接口：
  - 实时：`/feed/geo::<lat>;<lon>/?token=...` 或 `/feed/<city>/?token=...`
  - 搜索：`/search/?keyword=...&token=...`
  - 边界：`/map/bounds/?latlng=<lat1>,<lon1>,<lat2>,<lon2>&token=...`
- 字段映射：`data.aqi`、`data.dominentpol`、`data.iaqi.*.v`、`city.geo`、`time.s`、`forecast.daily.*`、`attributions`
- 缓存策略：实时 2–5 分钟、预测 30–60 分钟；限流时退避重试

## 环境与启动
- 环境变量：`DATABASE_URL`、`SECRET_KEY`（签名令牌）
- 依赖：`Flask`、`itsdangerous`、`Werkzeug`、`psycopg2-binary`
- 启动：`python -m flask --app backend.app:create_app run --host=0.0.0.0 --port=8000`

## 代码位置索引
- 应用工厂：`backend/app/__init__.py:6`
- 认证路由：`backend/app/api/auth/routes.py:8`、`:22`、`:35`
- 仓储：`backend/app/repositories/users.py:4`（查询/创建/校验）
- 令牌服务：`backend/app/services/auth.py:1`（签发/校验）
- 响应封装：`backend/app/utils/response.py:1`
